<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medical Utility Tool</title>
  <style>
    /* [unchanged styles] */
  </style>
</head>
<body>
  <!-- [unchanged HTML structure above] -->

<script>
  // === Headers Data ===
  const headers = {
    /* [unchanged headers] */
  };

  // === Hints ===
  const hints = [
    /* [unchanged hints] */
  ];
  let hintIndex = 0;
  setInterval(() => {
    document.getElementById('hint-strip').textContent = hints[hintIndex];
    hintIndex = (hintIndex + 1) % hints.length;
  }, 7000);

  // === Headers dropdown ===
  const headersBtn = document.getElementById('headers-btn');
  const headersDropdown = document.getElementById('dropdown-headers');
  let headersVisible = false;

  function toggleHeaders() {
    if (headersVisible) {
      headersDropdown.classList.remove('show');
      headersVisible = false;
      return;
    }
    let html = '';
    for (const label in headers) {
      html += `<div class="dropdown-item">
        <span>${label}</span>
        <button aria-label="Copy citation for ${label}" onclick="copyText(this)" data-text="${headers[label].replace(/"/g, '&quot;')}">Copy</button>
      </div>`;
    }
    headersDropdown.innerHTML = html;
    headersDropdown.classList.add('show');
    headersVisible = true;
    if (formularyVisible) toggleFormulary();
  }

  document.addEventListener('click', (e) => {
    if (!headersDropdown.contains(e.target) && e.target !== headersBtn) {
      if (headersVisible) {
        headersDropdown.classList.remove('show');
        headersVisible = false;
      }
    }
  });

  function copyText(button) {
    const text = button.getAttribute('data-text');
    navigator.clipboard.writeText(text).then(() => {
      const ghost = document.getElementById('copy-ghost');
      ghost.style.display = 'block';
      setTimeout(() => ghost.style.display = 'none', 5000);
    }).catch(() => alert('Copy failed'));
  }

  function goBack() {
    alert('Going back to main home page...');
  }
  function navigate(section) {
    document.getElementById('main-content').innerHTML = `<h2>Loading ${section}...</h2>`;
    if (headersVisible) {
      headersDropdown.classList.remove('show');
      headersVisible = false;
    }
    if (formularyVisible) toggleFormulary();
  }

  const formularyOverlay = document.getElementById('formulary-overlay');
  const formularyBtn = document.getElementById('formulary-btn');
  const searchInput = document.getElementById('search-input');
  const searchButton = document.getElementById('search-button');
  const resultsContainer = document.getElementById('formulary-results');
  let formularyVisible = false;
  let formularyData = [];

  async function fetchFormularyData() {
    try {
      const res = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQjeLiC5oKL6wkw7fqz00Gg7qFG22vJabTjVLO4u4sN_zBIrLAbhvxhfBoYnMF2P935KgsnRBDdmqRl/pub?output=csv');
      const csvText = await res.text();
      formularyData = parseCSV(csvText);
    } catch (e) {
      resultsContainer.textContent = 'Error loading formulary data.';
      console.error('Formulary data fetch error:', e);
    }
  }

  function parseCSV(str) {
    const lines = str.trim().split('\n');
    const headers = lines[0].split(/\t|,/).map(h => h.trim());
    const data = [];
    for (let i = 1; i < lines.length; i++) {
      const row = lines[i].split(/\t|,/);
      if (row.length < headers.length) continue;
      const obj = {};
      for (let j = 0; j < headers.length; j++) {
        obj[headers[j]] = row[j] ? row[j].trim() : '';
      }
      data.push(obj);
    }
    return data;
  }

  function toggleFormulary() {
    if (formularyVisible) {
      formularyOverlay.style.display = 'none';
      formularyVisible = false;
      formularyBtn.style.background = 'rgba(20, 74, 145, 0.8)';
    } else {
      formularyOverlay.style.display = 'block';
      formularyVisible = true;
      formularyBtn.style.background = '#3b82f6';
      resultsContainer.textContent = 'Enter a search term and click Search.';
      searchInput.value = '';
      searchInput.focus();
      if (headersVisible) toggleHeaders();
      if (formularyData.length === 0) {
        fetchFormularyData();
      }
    }
  }

  function searchFormulary() {
    const term = searchInput.value.trim().toLowerCase();
    if (!term) {
      resultsContainer.textContent = 'Please enter a search term.';
      return;
    }
    const filtered = formularyData.filter(item => 
      item['Drug Ingredient'] && 
      item['Reference Brand Name'] && 
      item['Drug Ingredient'].toLowerCase().includes(term)
    );
    if (filtered.length === 0) {
      resultsContainer.textContent = 'No matching drugs found.';
      return;
    }
    const html = filtered.map(item => {
      const drug = item['Drug Ingredient'];
      const brand = item['Reference Brand Name'];
      const citation = item['General citation (All body parts)'] || '';
      const safeCitation = citation.replace(/`/g, '\\`');
      return `<div class="formulary-entry">
        <span>${drug} â€” ${brand}</span>
        <button onclick="copyCitation(`${safeCitation}`)">Copy</button>
      </div>`;
    }).join('');
    resultsContainer.innerHTML = html;
  }

  function copyCitation(text) {
    navigator.clipboard.writeText(text).then(() => {
      const ghost = document.getElementById('copy-ghost');
      ghost.style.display = 'block';
      setTimeout(() => ghost.style.display = 'none', 5000);
    }).catch(() => alert('Copy failed'));
  }

  searchButton.addEventListener('click', searchFormulary);
  searchInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      searchFormulary();
    }
  });
</script>
</body>
</html>
