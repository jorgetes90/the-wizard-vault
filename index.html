<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medical Utility Tool</title>
  <!-- Styles omitted for brevity -->
</head>
<body>
  <!-- Toolbar, Content, and Elements Omitted for Brevity -->

  <!-- Full page formulary overlay -->
  <div id="formulary-overlay" aria-hidden="true">
    <div id="formulary-header">
      <h2>CA Drug Formulary Search</h2>
      <button id="formulary-close" onclick="toggleFormulary()">Close</button>
    </div>
    <div id="search-container">
      <input id="search-input" type="search" placeholder="Search drug ingredient..." />
      <button id="search-button">Search</button>
    </div>
    <div id="formulary-results">Enter a search term and click Search.</div>
  </div>

<script>
  // Assume headers + hint strip code already included above...

  // === Formulary Search Overlay Logic ===
  const formularyOverlay = document.getElementById('formulary-overlay');
  const formularyBtn = document.getElementById('formulary-btn');
  const searchInput = document.getElementById('search-input');
  const searchButton = document.getElementById('search-button');
  const resultsContainer = document.getElementById('formulary-results');
  let formularyVisible = false;
  let formularyData = [];

  async function fetchFormularyData() {
    try {
      const res = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQjeLiC5oKL6wkw7fqz00Gg7qFG22vJabTjVLO4u4sN_zBIrLAbhvxhfBoYnMF2P935KgsnRBDdmqRl/pub?output=csv');
      const csvText = await res.text();
      formularyData = parseCSV(csvText);
    } catch (e) {
      resultsContainer.textContent = 'Error loading formulary data.';
      console.error('Formulary data fetch error:', e);
    }
  }

  function parseCSV(str) {
    const lines = str.trim().split('\n');
    const headers = lines[0].split(/\t|,/).map(h => h.trim());
    const data = [];
    for (let i = 1; i < lines.length; i++) {
      const row = lines[i].split(/\t|,/);
      if (row.length < headers.length) continue;
      const obj = {};
      for (let j = 0; j < headers.length; j++) {
        obj[headers[j]] = row[j] ? row[j].trim() : '';
      }
      data.push(obj);
    }
    return data;
  }

  function toggleFormulary() {
    if (formularyVisible) {
      formularyOverlay.style.display = 'none';
      formularyVisible = false;
      formularyBtn.style.background = 'rgba(20, 74, 145, 0.8)';
    } else {
      formularyOverlay.style.display = 'block';
      formularyVisible = true;
      formularyBtn.style.background = '#3b82f6';
      resultsContainer.textContent = 'Enter a search term and click Search.';
      searchInput.value = '';
      searchInput.focus();
      if (formularyData.length === 0) {
        fetchFormularyData();
      }
    }
  }

  function searchFormulary() {
    const term = searchInput.value.trim().toLowerCase();
    if (!term) {
      resultsContainer.textContent = 'Please enter a search term.';
      return;
    }
    const filtered = formularyData.filter(item => 
      item['Drug Ingredient'] && 
      item['Reference Brand Name'] && 
      item['Drug Ingredient'].toLowerCase().includes(term)
    );
    if (filtered.length === 0) {
      resultsContainer.textContent = 'No matching drugs found.';
      return;
    }
    const html = filtered.map((item, index) => {
      const drug = item['Drug Ingredient'];
      const brand = item['Reference Brand Name'];
      const citation = item['General citation (All body parts)'] || '';
      const elementId = `formulary-citation-${index}`;
      return `<div class="formulary-entry">
        <span>${drug} â€” ${brand}</span>
        <button onclick="copyCitationById('${elementId}')">Copy</button>
        <pre id="${elementId}" style="display:none">${citation}</pre>
      </div>`;
    }).join('');
    resultsContainer.innerHTML = html;
  }

  function copyCitationById(id) {
    const text = document.getElementById(id).textContent;
    navigator.clipboard.writeText(text).then(() => {
      const ghost = document.getElementById('copy-ghost');
      ghost.style.display = 'block';
      setTimeout(() => ghost.style.display = 'none', 5000);
    }).catch(() => alert('Copy failed'));
  }

  searchButton.addEventListener('click', searchFormulary);
  searchInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      searchFormulary();
    }
  });
</script>
</body>
</html>
