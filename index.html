<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medical Utility Tool</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      color: white;
    }
    .toolbar {
      display: flex;
      justify-content: space-around;
      align-items: center;
      background-color: #0b2349;
      padding: 10px;
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.6);
      position: sticky;
      top: 0;
      z-index: 10000; /* toolbar always on top */
      user-select: none;
    }
    .toolbar button {
      background: #144a91cc; /* semi-transparent dark blue */
      border: none;
      padding: 10px 15px;
      margin: 0 5px;
      color: white;
      font-weight: bold;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
      user-select: none;
    }
    .toolbar button:hover {
      background: #1f5db3ee;
    }

    .page-content {
      padding: 20px;
      position: relative;
      min-height: 80vh;
      background: white;
      color: black;
      border-radius: 8px;
      max-width: 900px;
      margin: 20px auto;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }

    .hint-strip {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #0b2349cc; /* semi-transparent dark blue */
      color: #ffe066;
      padding: 10px;
      text-align: center;
      font-style: italic;
      font-size: 14px;
      z-index: 9999;
      user-select: none;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.5);
    }

    /* Adjusted z-index to be above Word Editor */
    .dropdown {
      display: none;
      position: absolute;
      top: 60px;
      left: 20px;
      right: 20px;
      background: rgba(11, 35, 73, 0.85); /* see-through dark blue */
      border: 1px solid #144a91cc;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.7);
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      z-index: 11001; /* above word editor */
      flex-wrap: wrap;
      gap: 10px;
      color: white;
      font-size: 14px;
    }

    .dropdown.show {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .dropdown-item {
      background: rgba(20, 74, 145, 0.6);
      border: 1px solid #2c77d3aa;
      padding: 10px;
      border-radius: 8px;
      width: calc(50% - 15px);
      position: relative;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
      cursor: default;
    }

    .dropdown-item span {
      flex: 1;
      cursor: pointer;
      user-select: text;
    }

    .dropdown-item button {
      background: #1f5db3ee;
      border: none;
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 5px;
      cursor: pointer;
      color: white;
      font-weight: normal;
      transition: background 0.3s;
      user-select: none;
      margin-left: 10px;
    }
    .dropdown-item button:hover {
      background: #3b82f6;
    }

    /* Formulary full page overlay */
    #formulary-overlay {
      display: none;
      position: fixed;
      top: 40px; /* below toolbar */
      left: 0; right: 0; bottom: 0;
      background: rgba(11, 35, 73, 0.95);
      color: white;
      z-index: 11002; /* above headers dropdown and word editor */
      padding: 20px;
      overflow-y: auto;
      font-size: 14px;
      font-family: Arial, sans-serif;
    }
    #formulary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    #formulary-header h2 {
      margin: 0;
    }
    #formulary-close {
      background: #1f5db3ee;
      border: none;
      color: white;
      padding: 8px 14px;
      font-weight: bold;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    #formulary-close:hover {
      background: #3b82f6;
    }
    #search-container {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    #search-input {
      flex-grow: 1;
      padding: 8px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
      outline: none;
    }
    #search-button {
      padding: 8px 20px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 5px;
      border: none;
      background: #1f5db3ee;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
    }
    #search-button:hover {
      background: #3b82f6;
    }
    #formulary-results {
      max-height: 70vh;
      overflow-y: auto;
      border: 1px solid #2c77d3aa;
      border-radius: 8px;
      background: rgba(20,74,145,0.2);
      padding: 10px;
      user-select: none;
    }
    .formulary-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid #2c77d3aa;
      font-weight: bold;
    }
    .formulary-entry:last-child {
      border-bottom: none;
    }
    .formulary-entry button {
      background: #1f5db3ee;
      border: none;
      padding: 5px 12px;
      border-radius: 5px;
      color: white;
      font-weight: normal;
      cursor: pointer;
      transition: background 0.3s;
    }
    .formulary-entry button:hover {
      background: #3b82f6;
    }

    .copy-ghost {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 12000;
      display: none;
      animation: glow-fade 5s ease-in-out;
      pointer-events: none;
      user-select: none;
      width: 120px;
      filter: drop-shadow(0 0 20px #58a6ff);
    }
    @keyframes glow-fade {
      0% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* Word Editor full-page overlay */
    #word-editor-overlay {
      display: none;
      position: fixed;
      top: 40px; /* below toolbar */
      left: 0; right: 0; bottom: 0;
      background: #e3e8f7;
      z-index: 11000; /* BELOW headers dropdown and formulary */
      flex-direction: column;
      border-top: 4px solid #144a91;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      user-select: text;
    }

    #word-editor-header {
      background: #144a91cc;
      color: white;
      padding: 10px 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: bold;
      font-size: 18px;
    }
    #word-editor-back-btn {
      background: #1f5db3ee;
      border: none;
      color: white;
      padding: 6px 14px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
      user-select: none;
    }
    #word-editor-back-btn:hover {
      background: #3b82f6;
    }
    #word-editor-iframe {
      flex-grow: 1;
      border: none;
      width: 100%;
      height: calc(100vh - 40px - 48px); /* full height minus toolbar and header */
    }

    /* Wizard and chat bubble container and style */
    #wizard-container {
      position: fixed;
      top: 200px;
      left: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      max-width: 350px;
      padding: 8px 12px;
      background: rgba(31, 93, 179, 0.85);
      border-radius: 15px;
      box-shadow: 0 0 15px #58a6ff;
      animation: glow 2s ease-in-out infinite alternate;
      z-index: 999; /* behind word editor and dropdown */
      user-select: none;
    }

    @keyframes glow {
      0% {
        box-shadow: 0 0 15px #58a6ff;
      }
      100% {
        box-shadow: 0 0 30px #58a6ff;
      }
    }

    #wizard-img {
      width: 150px;
      height: auto;
      border-radius: 10px;
      user-select: none;
    }

    #bubble-body {
      white-space: pre-line;       /* preserve line breaks */
      overflow-wrap: break-word;
      word-break: break-word;
      max-height: 200px;           /* limit height */
      overflow-y: auto;            /* vertical scrollbar if content too big */
      padding-right: 8px;          /* prevent scrollbar overlap */
      line-height: 1.3;
      font-size: 15px;
    }

  </style>
</head>
<body>
  <div class="toolbar" role="navigation" aria-label="Main toolbar">
    <button onclick="window.top.location.href='https://script.google.com/macros/s/AKfycbyL54f4XL0gl_FJAgl26TMRAX06TWJUyYQropWj1K0uBQnSAlOqSIuOqZfUVctp-3z5/exec'">‚Üê Back</button>
    <button id="headers-btn" aria-haspopup="true" aria-expanded="false" aria-controls="dropdown-headers" onclick="toggleHeaders()">Headers</button>
    <button id="word-editor-btn" aria-haspopup="true" aria-expanded="false" onclick="toggleWordEditor()">Word Editor</button>
    <button id="formulary-btn" aria-haspopup="true" aria-expanded="false" onclick="toggleFormulary()">CA Formulary</button>
    <button onclick="navigate('jurisdiction')">Jurisdiction</button>
    <button onclick="navigate('updates')">Guideline Updates</button>
    <button onclick="navigate('jargons')">Jargons</button>
  </div>

  <div class="page-content" id="main-content" tabindex="-1">
    <h1>Welcome to the Medical Utility Tool</h1>
    <p>Select a tool from the toolbar above.</p>

    <div id="dropdown-headers" class="dropdown" role="menu" aria-label="Headers menu"></div>
  </div>

  <div class="hint-strip" id="hint-strip">Loading hints...</div>

  <img id="copy-ghost" class="copy-ghost" src="https://i.postimg.cc/d0jsn69H/Ghost.png" alt="Copied!" />

  <!-- Word Editor overlay -->
  <div id="word-editor-overlay" aria-hidden="true" role="dialog" aria-label="Word Editor">
    <div id="word-editor-header">
      Word Editor
      <button id="word-editor-back-btn" aria-label="Close Word Editor" onclick="toggleWordEditor()">Back</button>
    </div>
    <iframe id="word-editor-iframe" src="https://tesecumj.neocities.org/" title="Embedded Word Editor"></iframe>
  </div>

  <!-- Full page formulary overlay -->
  <div id="formulary-overlay" aria-hidden="true" role="dialog" aria-label="California Drug Formulary Search">
    <div id="formulary-header">
      <h2>CA Drug Formulary Search</h2>
      <button id="formulary-close" aria-label="Close Formulary Search" onclick="toggleFormulary()">Close</button>
    </div>
    <div id="search-container">
      <input id="search-input" type="search" placeholder="Search drug ingredient or brand name..." aria-label="Search drug ingredient or brand name" />
      <button id="search-button">Search</button>
    </div>
    <div id="formulary-results">Enter a search term and click Search.</div>
  </div>

  <!-- Wizard and chat bubble -->
  <div id="wizard-container" aria-live="polite" aria-atomic="true" aria-relevant="additions">
    <img id="wizard-img" src="https://i.postimg.cc/g0CKgrDV/Chat-GPT-Image-Jun-23-2025-02-01-13-PM.png" alt="Wizard" />
    <div id="chat-bubble">
      <div id="bubble-header">üö® <strong> Updates!! :</strong></div>
      <div id="bubble-body">Loading...</div>
    </div>
  </div>

<script>
  // === Headers Data ===
  const headers = {
    "Shoulder Disorders": "California Medical Treatment Utilization Schedule (MTUS)/ACOEM Practice Guidelines\nShoulder Disorders (MTUS Effective Date August 10, 2023)",
    "Knee Disorders": "California Medical Treatment Utilization Schedule (MTUS)/ACOEM Practice Guidelines\nKnee Disorders (MTUS Effective Date September 21, 2020)",
    "Low Back Disorders": "California Medical Treatment Utilization Schedule (MTUS)/ACOEM Practice Guidelines\nLow Back Disorders (MTUS Effective Date November 23, 2021)",
    "Cervical and Thoracic Spine": "California Medical Treatment Utilization Schedule (MTUS)/ACOEM Practice Guidelines\nCervical and Thoracic Spine (MTUS Effective Date April 18, 2019)",
    "Hand, Wrist, and Forearm Disorders": "California Medical Treatment Utilization Schedule (MTUS)/ACOEM Practice Guidelines\nHand, Wrist, and Forearm Disorders (MTUS Effective Date November 10, 2023)",
    "Ankle and Foot Disorders": "California Medical Treatment Utilization Schedule (MTUS)/ACOEM Practice Guidelines\nAnkle and Foot Disorders (MTUS Effective Date April 18, 2019)",
    "Elbow Disorders": "California Medical Treatment Utilization Schedule (MTUS)/ACOEM Practice Guidelines\nElbow Disorders (MTUS Effective Date April 18, 2019)",
    "Hip and Groin Disorders": "California Medical Treatment Utilization Schedule (MTUS)/ACOEM Practice Guidelines\nHip and Groin Disorders (MTUS Effective Date October 7, 2019)",
    "Chronic Pain": "California Medical Treatment Utilization Schedule (MTUS)/ACOEM Practice Guidelines\nChronic Pain (Effective Date June 1, 2025)",
    "Antiemetics": "California Medical Treatment Utilization Schedule (MTUS) / ACOEM Practice Guidelines\nAntiemetics (MTUS Effective Date: October 26, 2020)",
    "Cannabis": "California Medical Treatment Utilization Schedule (MTUS) / ACOEM Practice Guidelines\nCannabis (MTUS Effective Date: June 1, 2025)",
    "COVID-19 (Coronavirus)": "California Medical Treatment Utilization Schedule (MTUS) / ACOEM Practice Guidelines\nCOVID-19 (Coronavirus) (MTUS Effective Date: November 10, 2023)",
    "Eye Disorders": "California Medical Treatment Utilization Schedule (MTUS) / ACOEM Practice Guidelines\nEye Disorders (MTUS Effective Date: December 1, 2017)",
    "Interstitial Lung Diseases": "California Medical Treatment Utilization Schedule (MTUS) / ACOEM Practice Guidelines\nInterstitial Lung Diseases (MTUS Effective Date: September 21, 2020)",
    "Occupational Asthma": "California Medical Treatment Utilization Schedule (MTUS) / ACOEM Practice Guidelines\nOccupational Asthma (MTUS Effective Date: September 21, 2020)",
    "Opioids": "California Medical Treatment Utilization Schedule (MTUS) / ACOEM Practice Guidelines\nOpioids (MTUS Effective Date: March 27, 2024)",
    "Traumatic Brain Injury": "California Medical Treatment Utilization Schedule (MTUS) / ACOEM Practice Guidelines\nTraumatic Brain Injury (MTUS Effective Date: October 31, 2018)",
    "Workplace Mental Health": "California Medical Treatment Utilization Schedule (MTUS) / ACOEM Practice Guidelines\nWorkplace Mental Health (MTUS Effective Date: August 11, 2019)",
    "Posttraumatic Stress Disorder and Acute Stress Disorder": "California Medical Treatment Utilization Schedule (MTUS) / ACOEM Practice Guidelines\nPosttraumatic Stress Disorder and Acute Stress Disorder (MTUS Effective Date: April 18, 2019)",
    "Anxiety Disorders": "California Medical Treatment Utilization Schedule (MTUS) / ACOEM Practice Guidelines\nAnxiety Disorders (MTUS Effective Date: July 19, 2023)",
    "Depressive Disorders": "California Medical Treatment Utilization Schedule (MTUS) / ACOEM Practice Guidelines\nDepressive Disorders (MTUS Effective Date: July 19, 2023)"
  };

  // Build headers dropdown menu items
  const dropdownHeaders = document.getElementById('dropdown-headers');
  for (const [header, content] of Object.entries(headers)) {
    const item = document.createElement('div');
    item.className = 'dropdown-item';
    const span = document.createElement('span');
    span.textContent = header;
    span.tabIndex = 0;
    span.setAttribute('role', 'menuitem');
    // Clicking on header text copies the content
    span.addEventListener('click', () => {
      copyTextToClipboard(content);
      showCopyGhost();
    });
    span.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        copyTextToClipboard(content);
        showCopyGhost();
      }
    });
    // Copy button next to each header
    const copyBtn = document.createElement('button');
    copyBtn.textContent = 'Copy';
    copyBtn.ariaLabel = `Copy text for ${header}`;
    copyBtn.addEventListener('click', () => {
      copyTextToClipboard(content);
      showCopyGhost();
    });
    item.appendChild(span);
    item.appendChild(copyBtn);
    dropdownHeaders.appendChild(item);
  }

  function toggleHeaders() {
    const dropdown = dropdownHeaders;
    const btn = document.getElementById('headers-btn');
    if (dropdown.classList.contains('show')) {
      dropdown.classList.remove('show');
      btn.setAttribute('aria-expanded', 'false');
    } else {
      dropdown.classList.add('show');
      btn.setAttribute('aria-expanded', 'true');
      dropdown.focus();
    }
  }

  // Copy helper function
  function copyTextToClipboard(text) {
    if (!navigator.clipboard) {
      // fallback
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
      } catch (err) {
        alert('Copy failed');
      }
      document.body.removeChild(textarea);
      return;
    }
    navigator.clipboard.writeText(text).catch(() => alert('Copy failed'));
  }

  // Show ghost image on copy
  function showCopyGhost() {
    const ghost = document.getElementById('copy-ghost');
    if (!ghost) return;
    ghost.style.display = 'block';
    ghost.style.animation = 'none';
    // Trigger reflow to restart animation
    ghost.offsetHeight;
    ghost.style.animation = null;
    setTimeout(() => {
      ghost.style.display = 'none';
    }, 5000);
  }

  // === Word Editor Overlay ===
  const wordEditorBtn = document.getElementById('word-editor-btn');
  const wordEditorOverlay = document.getElementById('word-editor-overlay');
  let wordEditorOpen = false;
  function toggleWordEditor() {
    wordEditorOpen = !wordEditorOpen;
    if (wordEditorOpen) {
      wordEditorOverlay.style.display = 'flex';
      wordEditorBtn.setAttribute('aria-expanded', 'true');
      document.getElementById('main-content').setAttribute('aria-hidden', 'true');
    } else {
      wordEditorOverlay.style.display = 'none';
      wordEditorBtn.setAttribute('aria-expanded', 'false');
      document.getElementById('main-content').removeAttribute('aria-hidden');
    }
  }
  wordEditorBtn.addEventListener('click', toggleWordEditor);

  // === Formulary Overlay ===
  const formularyBtn = document.getElementById('formulary-btn');
  const formularyOverlay = document.getElementById('formulary-overlay');
  let formularyOpen = false;

  // Store loaded JSON data globally
  let formularyData = null;

  function toggleFormulary() {
    formularyOpen = !formularyOpen;
    if (formularyOpen) {
      formularyOverlay.style.display = 'block';
      formularyBtn.setAttribute('aria-expanded', 'true');
      document.getElementById('main-content').setAttribute('aria-hidden', 'true');
      if (!formularyData) {
        loadFormularyData();
      }
    } else {
      formularyOverlay.style.display = 'none';
      formularyBtn.setAttribute('aria-expanded', 'false');
      document.getElementById('main-content').removeAttribute('aria-hidden');
    }
  }
  formularyBtn.addEventListener('click', toggleFormulary);

  document.getElementById('formulary-close').addEventListener('click', toggleFormulary);

  async function loadFormularyData() {
    try {
      const response = await fetch('2025 ds ur cheat sheet formulary.json');
      formularyData = await response.json();
      document.getElementById('formulary-results').textContent = 'Formulary data loaded. Enter a search term and click Search.';
    } catch (e) {
      document.getElementById('formulary-results').textContent = 'Error loading formulary data.';
    }
  }

  // Search button handler
  document.getElementById('search-button').addEventListener('click', () => {
    const term = document.getElementById('search-input').value.trim().toLowerCase();
    if (!term) return;
    performFormularySearch(term);
  });

  // Also search on Enter key in input
  document.getElementById('search-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('search-button').click();
    }
  });

  function performFormularySearch(term) {
    if (!formularyData) {
      document.getElementById('formulary-results').textContent = 'Formulary data not loaded yet.';
      return;
    }

    const results = formularyData.filter(drug => {
      const generic = drug['Generic Name']?.toLowerCase() || '';
      const category = drug['Therapeutic Category']?.toLowerCase() || '';
      return generic.includes(term) || category.includes(term);
    });

    const container = document.getElementById('formulary-results');
    container.innerHTML = '';

    if (results.length === 0) {
      container.textContent = 'No results found.';
      return;
    }

    for (const drug of results) {
      const entry = document.createElement('div');
      entry.className = 'formulary-entry';

      const label = document.createElement('span');
      label.textContent = `${drug['Generic Name']} (${drug['Therapeutic Category']})`;
      label.title = `${drug['Generic Name']} - ${drug['Therapeutic Category']}`;
      label.style.userSelect = 'text';
      label.style.flexGrow = '1';

      const copyBtn = document.createElement('button');
      copyBtn.textContent = 'Copy';
      copyBtn.ariaLabel = `Copy formulary details for ${drug['Generic Name']}`;
      copyBtn.addEventListener('click', () => {
        const copyText = generateCopyText(drug);
        copyTextToClipboard(copyText);
        showCopyGhost();
      });

      entry.appendChild(label);
      entry.appendChild(copyBtn);
      container.appendChild(entry);
    }
  }

  // Build the full copy text for a drug entry
  function generateCopyText(drug) {
    // Template format from your original spec:
    // Template text (header), then Therapeutic Category + Generic Name,
    // then Phase A, B, Perioperative if flagged (marked 'x'),
    // then Special Considerations 1-4 at the end.
    // For now, assume drug object fields match JSON keys exactly.

    const templateText = `**${drug['Therapeutic Category']} ‚Äî ${drug['Generic Name']}**\n\n`;

    let phasesText = '';
    if (drug['Phase A']?.toLowerCase() === 'x') phasesText += `Phase A: ${drug['Phase A Full Text'] || ''}\n\n`;
    if (drug['Phase B']?.toLowerCase() === 'x') phasesText += `Phase B: ${drug['Phase B Full Text'] || ''}\n\n`;
    if (drug['Perioperative']?.toLowerCase() === 'x') phasesText += `Perioperative: ${drug['Perioperative Full Text'] || ''}\n\n`;

    let specialConsiderations = '';
    for (let i = 1; i <= 4; i++) {
      const key = `Special Consideration ${i}`;
      if (drug[key]) {
        specialConsiderations += `${drug[key]}\n\n`;
      }
    }

    return `${templateText}${phasesText}${specialConsiderations}`.trim();
  }

  // === Hint strip content cycling ===
  const hints = [
    "You can copy guideline headers by clicking them or their Copy buttons.",
    "Use the CA Formulary button to search for drug ingredients or categories.",
    "The Word Editor button opens an embedded Word processor.",
    "Click Copy buttons to see the ghost animation confirming the copy.",
    "Press ESC to close dropdowns or overlays.",
  ];
  let hintIndex = 0;
  const hintStrip = document.getElementById('hint-strip');
  setInterval(() => {
    hintIndex = (hintIndex + 1) % hints.length;
    hintStrip.textContent = hints[hintIndex];
  }, 10000);

  // Navigation buttons placeholders
  function navigate(page) {
    alert(`Navigate to ${page} page (functionality not implemented).`);
  }

  // Close overlays and dropdowns on ESC key
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      // Close headers dropdown
      if (dropdownHeaders.classList.contains('show')) {
        dropdownHeaders.classList.remove('show');
        document.getElementById('headers-btn').setAttribute('aria-expanded', 'false');
      }
      // Close formulary
      if (formularyOpen) toggleFormulary();
      // Close word editor
      if (wordEditorOpen) toggleWordEditor();
    }
  });

  // === New snippet added exactly here ===
  // Show #copy-ghost when clicking any header copy button
  document.getElementById('dropdown-headers').addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON') {
      const ghost = document.getElementById('copy-ghost');
      if (ghost) {
        ghost.style.display = 'block';
        setTimeout(() => {
          ghost.style.display = 'none';
        }, 5000);
      }
    }
  });
</script>
</body>
</html>
